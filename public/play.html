<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Simple Rummy</title>
<script src="/socket.io/socket.io.js"></script>

<style>
body{
    margin:0;
    background:#14532d;
    font-family:sans-serif;
    color:white;
    text-align:center;
}

.topbar{
    display:flex;
    justify-content:space-between;
    padding:10px;
    background:black;
}

.players{
    display:flex;
    justify-content:center;
    gap:10px;
    margin:10px;
}

.player{
    padding:8px 12px;
    background:#222;
    border-radius:6px;
}

.active{
    background:green;
}

.table{
    margin:20px;
}

.card{
    display:inline-block;
    padding:8px;
    margin:4px;
    background:white;
    color:black;
    border-radius:5px;
    min-width:30px;
    cursor:pointer;
}

.red{
    color:red;
}

.buttons{
    margin-top:10px;
}

button{
    padding:8px 12px;
    margin:5px;
    border:none;
    border-radius:5px;
    font-weight:bold;
}
.draw{background:orange;}
.drop{background:red;color:white;}
.sort{background:blue;color:white;}
.declare{background:green;color:white;}
</style>
</head>
<body>

<div class="topbar">
<div>Coins: <span id="coins">0</span></div>
<div id="status">Waiting...</div>
</div>

<div class="players" id="players"></div>

<div class="table">
<div>Closed Deck</div>
<button class="draw" onclick="drawCard()">DRAW</button>

<div style="margin-top:10px;">
Open Card: <span id="openCard">?</span>
</div>
</div>

<h3>Your Cards</h3>
<div id="myCards"></div>

<div class="buttons">
<button class="sort" onclick="sortCards()">SORT</button>
<button class="drop" onclick="dropGame()">DROP</button>
<button class="declare" onclick="declareGame()">DECLARE</button>
</div>

<script>

const socket = io();
const mode = localStorage.getItem("gameMode") || 2;

document.getElementById("coins").innerText =
localStorage.getItem("coins") || 0;

let myCards = [];
let isMyTurn = false;
let totalPlayers = 2;

socket.emit("joinGame", {
    name: localStorage.getItem("name"),
    mode: mode
});

socket.on("gameStart", (data)=>{

    totalPlayers = data.mode;

    document.getElementById("status").innerText =
    data.mode + " Player Table";

    myCards = data.myCards;
    document.getElementById("openCard").innerText =
    data.openCard;

    renderPlayers();
    renderCards();
});

socket.on("updateState", (data)=>{
    isMyTurn = (data.turn === 0);

    document.getElementById("status").innerText =
    "Turn: Player " + (data.turn+1) +
    " | Timer: " + data.timer;

    highlightTurn(data.turn);
});

socket.on("cardDrawn",(data)=>{
    myCards.push(data.card);
    renderCards();
});

socket.on("cardDiscarded",(data)=>{
    document.getElementById("openCard").innerText =
    data.openCard;
});

function renderPlayers(){
    const container =
    document.getElementById("players");
    container.innerHTML="";

    for(let i=0;i<totalPlayers;i++){
        const div=document.createElement("div");
        div.className="player";
        div.id="p"+i;
        div.innerText =
        (i===0?"YOU":"BOT "+i);
        container.appendChild(div);
    }
}

function highlightTurn(turn){
    for(let i=0;i<totalPlayers;i++){
        document.getElementById("p"+i)
        .classList.remove("active");
    }
    document.getElementById("p"+turn)
    .classList.add("active");
}

function renderCards(){
    const container =
    document.getElementById("myCards");
    container.innerHTML="";

    myCards.forEach((card,index)=>{
        const div=document.createElement("div");
        div.className="card";

        if(card.includes("♥") ||
           card.includes("♦")){
            div.classList.add("red");
        }

        div.innerText=card;

        div.onclick=()=>{
            if(!isMyTurn) return;
            discardCard(index);
        };

        container.appendChild(div);
    });
}

function drawCard(){
    if(!isMyTurn) return;
    socket.emit("drawCard");
}

function discardCard(index){
    const card=myCards[index];
    myCards.splice(index,1);
    socket.emit("discardCard",{card});
    renderCards();
}

function sortCards(){
    myCards.sort();
    renderCards();
}

function dropGame(){
    alert("You Dropped!");
    location.reload();
}

function declareGame(){
    if(myCards.length !== 13){
        alert("Invalid Declare!");
        return;
    }
    alert("Declared! (Validation next level)");
}

</script>

</body>
</html>
