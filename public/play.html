<!DOCTYPE html>
<html>
<head>
    <title>Rummy Rex - High Stakes Bot Control</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <style>
        body { background: #073b1c; color: white; font-family: sans-serif; margin: 0; overflow: hidden; }
        .header { padding: 10px; display: flex; justify-content: space-between; background: #000; border-bottom: 2px solid gold; align-items: center; }
        .table { width: 92vw; height: 50vh; background: radial-gradient(circle, #1a5d2d, #052c1a); margin: 20px auto; border-radius: 180px; border: 8px solid #5d4037; position: relative; box-shadow: inset 0 0 60px #000; }
        
        .player { position: absolute; width: 65px; height: 65px; background: #222; border: 2px solid gold; border-radius: 50%; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 9px; transition: 0.3s; }
        .p1 { bottom: -35px; left: 50%; transform: translateX(-50%); } 
        .p2 { top: 50%; left: -35px; transform: translateY(-50%); }
        .p3 { top: -35px; left: 50%; transform: translateX(-50%); }
        .p4 { top: 50%; right: -35px; transform: translateY(-50%); }
        
        .active { border: 4px solid #00ff00 !important; box-shadow: 0 0 25px #00ff00; }
        .bot-bet { background: rgba(0,0,0,0.8); color: #00ff00; padding: 2px 5px; border-radius: 5px; font-size: 8px; margin-top: 2px; }

        .cards-area { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); display: flex; gap: 10px; }
        .deck, .open-card { width: 45px; height: 65px; background: white; border-radius: 5px; color: black; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 16px; box-shadow: 2px 2px 10px #000; }
        .deck { background: linear-gradient(to bottom, #ff4444, #990000); color: white; border: 1px solid #fff; }

        .hand { position: fixed; bottom: 85px; width: 100%; display: flex; justify-content: center; padding: 0 5px; }
        .card { width: 45px; height: 65px; background: white; border-radius: 5px; border: 1px solid #000; color: black; margin-left: -15px; display: flex; align-items: center; justify-content: center; font-weight: bold; box-shadow: -2px 0 8px #000; cursor: pointer; }
        
        .controls { position: fixed; bottom: 0; width: 100%; background: #000; padding: 15px 0; display: flex; justify-content: space-around; border-top: 2px solid gold; }
        .btn { padding: 10px 20px; border-radius: 6px; border: none; font-weight: bold; color: white; cursor: pointer; text-transform: uppercase; }
        
        #game-status { position: fixed; top: 60px; width: 100%; text-align: center; color: gold; font-weight: bold; font-size: 14px; text-shadow: 1px 1px 5px #000; }
    </style>
</head>
<body>

    <div class="header">
        <div style="color: gold;">ü™ô <span id="bal">0</span></div>
        <div style="color: gold; font-weight: bold;">‚Çπ<span id="stakeDisplay">0</span> TABLE</div>
        <button onclick="location.href='lobby.html'" style="background:red; color:white; border:none; padding:5px 10px; border-radius:4px;">EXIT</button>
    </div>

    <div id="game-status">WAITING FOR YOUR MOVE...</div>

    <div class="table">
        <div class="player p1 active" id="u1">YOU<div class="bot-bet" id="u1-bet">BET: ‚Çπ0</div><div style="color:#00ff00; font-weight:bold;" id="tm">30</div></div>
        <div class="player p2" id="u2">BOT 1<div class="bot-bet" id="u2-bet">WAITING</div></div>
        <div class="player p3" id="u3">BOT 2<div class="bot-bet" id="u3-bet">WAITING</div></div>
        <div class="player p4" id="u4">BOT 3<div class="bot-bet" id="u4-bet">WAITING</div></div>

        <div class="cards-area">
            <div class="deck" onclick="pickCard()">üé¥</div>
            <div class="open-card" id="openC">‚ô•Ô∏èA</div>
        </div>
    </div>

    <div class="hand" id="myHand"></div>

    <div class="controls">
        <button class="btn" style="background:#b71c1c;" onclick="endGame('LOSS')">DROP</button>
        <button class="btn" style="background:#0d47a1;" onclick="sortCards()">SORT</button>
        <button class="btn" style="background:#1b5e20;" onclick="checkDeclare()">DECLARE</button>
    </div>

    <script>
        const stake = parseInt(localStorage.getItem('currentEntryFee')) || 500;
        document.getElementById('stakeDisplay').innerText = stake.toLocaleString();
        document.getElementById('bal').innerText = localStorage.getItem('coins');
        document.getElementById('u1-bet').innerText = "BET: ‚Çπ" + stake;

        let hand = [];
        const suits = ['‚ô•Ô∏è','‚ô†Ô∏è','‚ô¶Ô∏è','‚ô£Ô∏è'];
        const vals = ['A','2','3','4','5','6','7','8','9','10','J','Q','K'];
        let timer = 30;
        let myTurn = true;

        function init() {
            for(let i=0; i<13; i++) hand.push(suits[Math.floor(Math.random()*4)] + vals[Math.floor(Math.random()*13)]);
            render();
            setInterval(() => { if(myTurn && timer > 0) { timer--; document.getElementById('tm').innerText = timer; } }, 1000);
        }

        function render() {
            const h = document.getElementById('myHand');
            h.innerHTML = '';
            hand.forEach((c, i) => {
                const d = document.createElement('div');
                d.className = 'card';
                d.style.color = (c.includes('‚ô•Ô∏è') || c.includes('‚ô¶Ô∏è')) ? 'red' : 'black';
                d.innerText = c;
                d.onclick = () => dropCard(i);
                h.appendChild(d);
            });
        }

        function pickCard() {
            if(!myTurn || hand.length >= 14) return;
            hand.push(suits[Math.floor(Math.random()*4)] + vals[Math.floor(Math.random()*13)]);
            render();
            document.getElementById('game-status').innerText = "DISCARD A CARD";
        }

        function dropCard(i) {
            if(!myTurn || hand.length < 14) return;
            const discarded = hand.splice(i, 1);
            document.getElementById('openC').innerText = discarded[0];
            document.getElementById('openC').style.color = (discarded[0].includes('‚ô•Ô∏è') || discarded[0].includes('‚ô¶Ô∏è')) ? 'red' : 'black';
            render();
            startBotSequence();
        }

        function startBotSequence() {
            myTurn = false;
            document.getElementById('u1').classList.remove('active');
            document.getElementById('game-status').innerText = "OPPONENTS ARE THINKING...";
            
            let sequence = [2, 3, 4];
            let step = 0;

            let interval = setInterval(() => {
                if(step > 0) {
                    document.getElementById('u' + sequence[step-1]).classList.remove('active');
                    document.getElementById('u' + sequence[step-1] + '-bet').innerText = "PLAYED";
                }
                
                if(step < 3) {
                    let botId = 'u' + sequence[step];
                    document.getElementById(botId).classList.add('active');
                    document.getElementById(botId + '-bet').innerText = "BETTING ‚Çπ" + stake;
                    step++;
                } else {
                    clearInterval(interval);
                    myTurn = true;
                    timer = 30;
                    document.getElementById('u1').classList.add('active');
                    document.getElementById('game-status').innerText = "YOUR TURN!";
                    // Logic to force loss: if user has high coins, bots win more
                    if(Math.random() > 0.8) endGame('LOSS'); 
                }
            }, 1500);
        }

        async function endGame(type) {
            const finalAmount = (type === 'WIN') ? stake * 3 : -stake;
            const uName = localStorage.getItem('name');
            
            const res = await fetch('/api/game/update-balance', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name: uName, amount: finalAmount })
            });
            const data = await res.json();
            localStorage.setItem('coins', data.newBalance);
            alert(type === 'WIN' ? "CONGRATS! WON ‚Çπ"+finalAmount : "GAME OVER! LOST ‚Çπ"+Math.abs(finalAmount));
            location.href = 'lobby.html';
        }

        function checkDeclare() {
            // User profit control logic
            if(Math.random() > 0.2) endGame('LOSS');
            else endGame('WIN');
        }

        function sortCards() { hand.sort(); render(); }
        init();
    </script>
</body>
</html>
