<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Circular Rummy</title>
<script src="/socket.io/socket.io.js"></script>

<style>
body{
    margin:0;
    background:#0f3d2e;
    font-family:sans-serif;
    color:white;
    text-align:center;
    overflow:hidden;
}

/* Top bar */
.topbar{
    display:flex;
    justify-content:space-between;
    padding:10px;
    background:black;
}

/* Table Circle */
.table-area{
    position:relative;
    width:100%;
    height:55vh;
    margin-top:10px;
}

.circle{
    position:absolute;
    top:50%;
    left:50%;
    transform:translate(-50%,-50%);
    width:300px;
    height:300px;
    border-radius:50%;
    background:#14532d;
    border:4px solid #222;
}

/* Player seats */
.player{
    position:absolute;
    padding:6px 10px;
    background:#222;
    border-radius:6px;
    font-size:12px;
}

.active{
    background:green;
}

/* Positions (6 max) */
.p0{ bottom:5px; left:50%; transform:translateX(-50%); }
.p1{ bottom:60px; left:10px; }
.p2{ top:40px; left:10px; }
.p3{ top:5px; left:50%; transform:translateX(-50%); }
.p4{ top:40px; right:10px; }
.p5{ bottom:60px; right:10px; }

/* Center controls */
.center{
    position:absolute;
    top:50%;
    left:50%;
    transform:translate(-50%,-50%);
}

button{
    padding:6px 10px;
    margin:4px;
    border:none;
    border-radius:5px;
    font-weight:bold;
}

.draw{background:orange;}
.sort{background:blue;color:white;}
.drop{background:red;color:white;}
.declare{background:green;color:white;}

.card{
    display:inline-block;
    padding:6px;
    margin:4px;
    background:white;
    color:black;
    border-radius:5px;
    min-width:28px;
    cursor:pointer;
    font-size:13px;
}

.red{ color:red; }

#myCards{
    position:fixed;
    bottom:60px;
    width:100%;
}

.bottom-buttons{
    position:fixed;
    bottom:10px;
    width:100%;
}
</style>
</head>
<body>

<div class="topbar">
<div>Coins: <span id="coins">0</span></div>
<div id="status">Waiting...</div>
</div>

<div class="table-area">
<div class="circle"></div>

<div id="players"></div>

<div class="center">
<div>Open: <span id="openCard">?</span></div>
<button class="draw" onclick="drawCard()">DRAW</button>
</div>
</div>

<div id="myCards"></div>

<div class="bottom-buttons">
<button class="sort" onclick="sortCards()">SORT</button>
<button class="drop" onclick="dropGame()">DROP</button>
<button class="declare" onclick="declareGame()">DECLARE</button>
</div>

<script>

const socket = io();
const mode = parseInt(localStorage.getItem("gameMode")) || 2;

document.getElementById("coins").innerText =
localStorage.getItem("coins") || 0;

let myCards=[];
let totalPlayers=2;
let isMyTurn=false;

socket.emit("joinGame",{
    name:localStorage.getItem("name"),
    mode:mode
});

socket.on("gameStart",(data)=>{
    totalPlayers=data.mode;
    myCards=data.myCards;
    document.getElementById("openCard").innerText=
    data.openCard;

    renderPlayers();
    renderCards();
});

socket.on("updateState",(data)=>{
    isMyTurn=(data.turn===0);

    document.getElementById("status").innerText=
    "Turn: Player "+(data.turn+1)+
    " | Timer: "+data.timer;

    highlightTurn(data.turn);
});

socket.on("cardDrawn",(data)=>{
    myCards.push(data.card);
    renderCards();
});

socket.on("cardDiscarded",(data)=>{
    document.getElementById("openCard").innerText=
    data.openCard;
});

function renderPlayers(){
    const container=document.getElementById("players");
    container.innerHTML="";

    for(let i=0;i<totalPlayers;i++){
        const div=document.createElement("div");
        div.className="player p"+i;
        div.id="player"+i;
        div.innerText=(i===0?"YOU":"BOT "+i);
        container.appendChild(div);
    }
}

function highlightTurn(turn){
    for(let i=0;i<totalPlayers;i++){
        const p=document.getElementById("player"+i);
        if(p) p.classList.remove("active");
    }
    const active=document.getElementById("player"+turn);
    if(active) active.classList.add("active");
}

function renderCards(){
    const container=document.getElementById("myCards");
    container.innerHTML="";

    myCards.forEach((card,index)=>{
        const div=document.createElement("div");
        div.className="card";

        if(card.includes("♥") || card.includes("♦")){
            div.classList.add("red");
        }

        div.innerText=card;

        div.onclick=()=>{
            if(!isMyTurn) return;
            discardCard(index);
        };

        container.appendChild(div);
    });
}

function drawCard(){
    if(!isMyTurn) return;
    socket.emit("drawCard");
}

function discardCard(index){
    const card=myCards[index];
    myCards.splice(index,1);
    socket.emit("discardCard",{card});
    renderCards();
}

function sortCards(){
    myCards.sort();
    renderCards();
}

function dropGame(){
    alert("You Dropped!");
    location.reload();
}

function declareGame(){
    if(myCards.length!==13){
        alert("Invalid Declare!");
        return;
    }
    alert("Declared! (Validation next step)");
}

</script>

</body>
</html>
