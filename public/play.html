<!DOCTYPE html>
<html>
<head>
    <title>Rummy Rex Pro - Real vs Bot</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <script src="/socket.io/socket.io.js"></script>
    <style>
        body { background: #073b1c; color: white; font-family: sans-serif; margin: 0; overflow: hidden; }
        .header { padding: 10px; display: flex; justify-content: space-between; background: #000; border-bottom: 2px solid gold; align-items: center; }
        .table { width: 92vw; height: 50vh; background: radial-gradient(circle, #1a5d2d, #052c1a); margin: 20px auto; border-radius: 180px; border: 8px solid #5d4037; position: relative; box-shadow: inset 0 0 60px #000; }
        .player { position: absolute; width: 65px; height: 65px; background: #222; border: 2px solid gold; border-radius: 50%; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 9px; }
        .p1 { bottom: -35px; left: 50%; transform: translateX(-50%); } 
        .p2 { top: 50%; left: -35px; transform: translateY(-50%); }
        .p3 { top: -35px; left: 50%; transform: translateX(-50%); }
        .p4 { top: 50%; right: -35px; transform: translateY(-50%); }
        .active { border: 4px solid #00ff00 !important; box-shadow: 0 0 25px #00ff00; }
        .cards-area { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); display: flex; gap: 10px; }
        .deck, .open-card { width: 45px; height: 65px; background: white; border-radius: 5px; color: black; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 16px; box-shadow: 2px 2px 10px #000; }
        .deck { background: linear-gradient(to bottom, #ff4444, #990000); color: white; border: 1px solid #fff; }
        .hand { position: fixed; bottom: 85px; width: 100%; display: flex; justify-content: center; padding: 0 5px; }
        .card { width: 45px; height: 65px; background: white; border-radius: 5px; border: 1px solid #000; color: black; margin-left: -15px; display: flex; align-items: center; justify-content: center; font-weight: bold; box-shadow: -2px 0 8px #000; cursor: pointer; }
        .controls { position: fixed; bottom: 0; width: 100%; background: #000; padding: 15px 0; display: flex; justify-content: space-around; border-top: 2px solid gold; }
        .btn { padding: 10px 20px; border-radius: 6px; border: none; font-weight: bold; color: white; cursor: pointer; }
        #status-txt { position: fixed; top: 60px; width: 100%; text-align: center; color: gold; font-weight: bold; }
    </style>
</head>
<body>
    <div class="header">
        <div>ü™ô <span id="bal">0</span></div>
        <div style="font-weight: bold;">‚Çπ<span id="stk">0</span> TABLE</div>
        <button onclick="location.href='lobby.html'" style="background:red; color:white; border:none; padding:5px 10px; border-radius:4px;">EXIT</button>
    </div>
    <div id="status-txt">FINDING PLAYERS...</div>
    <div class="table">
        <div class="player p1 active" id="u1">YOU<div id="tm" style="color:#00ff00;">30</div></div>
        <div class="player p2" id="u2">WAITING...</div>
        <div class="player p3" id="u3">BOT 2</div>
        <div class="player p4" id="u4">BOT 3</div>
        <div class="cards-area">
            <div class="deck" onclick="pick()">üé¥</div>
            <div class="open-card" id="opC">‚ô•Ô∏èA</div>
        </div>
    </div>
    <div class="hand" id="myHand"></div>
    <div class="controls">
        <button class="btn" style="background:#b71c1c;" onclick="end('LOSS')">DROP</button>
        <button class="btn" style="background:#0d47a1;" onclick="sortH()">SORT</button>
        <button class="btn" style="background:#1b5e20;" onclick="checkD()">DECLARE</button>
    </div>

    <script>
        const socket = io();
        const stake = parseInt(localStorage.getItem('currentEntryFee')) || 500;
        document.getElementById('stk').innerText = stake.toLocaleString();
        document.getElementById('bal').innerText = localStorage.getItem('coins');

        let hand = [], timer = 30, myTurn = false;

        socket.emit('joinGame', { name: localStorage.getItem('name') });

        socket.on('gameStart', (data) => {
            document.getElementById('status-txt').innerText = data.isBot ? "BOT GAME STARTED" : "REAL PLAYER JOINED!";
            document.getElementById('u2').innerText = data.isBot ? "Bot 1" : data.players[1];
            myTurn = true;
            init();
        });

        function init() {
            for(let i=0; i<13; i++) hand.push(['‚ô•Ô∏è','‚ô†Ô∏è','‚ô¶Ô∏è','‚ô£Ô∏è'][Math.floor(Math.random()*4)] + ['A','2','3','4','5','6','7','8','9','10','J','Q','K'][Math.floor(Math.random()*13)]);
            render();
            setInterval(() => { if(myTurn && timer > 0) { timer--; document.getElementById('tm').innerText = timer; } }, 1000);
        }

        function render() {
            const h = document.getElementById('myHand');
            h.innerHTML = '';
            hand.forEach((c, i) => {
                const d = document.createElement('div');
                d.className = 'card';
                d.style.color = (c.includes('‚ô•Ô∏è') || c.includes('‚ô¶Ô∏è')) ? 'red' : 'black';
                d.innerText = c;
                d.onclick = () => drop(i);
                h.appendChild(d);
            });
        }

        function pick() { if(myTurn && hand.length < 14) { hand.push('‚ô£Ô∏èK'); render(); } }

        function drop(i) {
            if(!myTurn || hand.length < 14) return;
            const discarded = hand.splice(i, 1);
            document.getElementById('opC').innerText = discarded[0];
            render();
            myTurn = false;
            document.getElementById('u1').classList.remove('active');
            // Bot/Opponent animation logic here...
            setTimeout(() => { myTurn = true; timer = 30; document.getElementById('u1').classList.add('active'); }, 3000);
        }

        async function end(type) {
            const amount = (type === 'WIN') ? stake * 3 : -stake;
            const res = await fetch('/api/game/update-balance', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name: localStorage.getItem('name'), amount: amount })
            });
            const d = await res.json();
            localStorage.setItem('coins', d.newBalance);
            alert(type === 'WIN' ? "WON ‚Çπ"+amount : "LOST ‚Çπ"+Math.abs(amount));
            location.href = 'lobby.html';
        }

        function checkD() { Math.random() > 0.3 ? end('LOSS') : end('WIN'); }
        function sortH() { hand.sort(); render(); }
    </script>
</body>
</html>
