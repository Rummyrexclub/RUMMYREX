<!DOCTYPE html>
<html>
<head>
    <title>Rummy Rex Pro - High Stakes</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <style>
        body { background: #073b1c; color: white; font-family: sans-serif; margin: 0; overflow: hidden; }
        .header { padding: 10px; display: flex; justify-content: space-between; background: #000; border-bottom: 2px solid gold; }
        .table { width: 92vw; height: 50vh; background: radial-gradient(circle, #1a5d2d, #052c1a); margin: 20px auto; border-radius: 180px; border: 8px solid #5d4037; position: relative; }
        .player { position: absolute; width: 60px; height: 60px; background: #222; border: 2px solid gold; border-radius: 50%; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 9px; }
        .p1 { bottom: -30px; left: 50%; transform: translateX(-50%); } 
        .p2 { top: 50%; left: -30px; transform: translateY(-50%); }
        .p3 { top: -30px; left: 50%; transform: translateX(-50%); }
        .p4 { top: 50%; right: -30px; transform: translateY(-50%); }
        .active { border: 4px solid #00ff00 !important; box-shadow: 0 0 20px #00ff00; }
        .cards-area { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); display: flex; gap: 10px; }
        .deck, .open-card { width: 45px; height: 65px; background: white; border-radius: 5px; color: black; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 16px; box-shadow: 2px 2px 10px #000; }
        .deck { background: linear-gradient(to bottom, #ff4444, #990000); color: white; }
        .hand { position: fixed; bottom: 80px; width: 100%; display: flex; justify-content: center; }
        .card { width: 45px; height: 65px; background: white; border-radius: 5px; border: 1px solid #000; color: black; margin-left: -15px; display: flex; align-items: center; justify-content: center; font-weight: bold; box-shadow: -2px 0 5px #000; }
        .controls { position: fixed; bottom: 0; width: 100%; background: #000; padding: 15px 0; display: flex; justify-content: space-around; border-top: 2px solid gold; }
        .btn { padding: 10px 15px; border-radius: 5px; border: none; font-weight: bold; color: white; cursor: pointer; }
    </style>
</head>
<body>
    <div class="header">
        <div style="color: gold;">ü™ô <span id="bal">0</span></div>
        <div style="color: gold;">STAKE: ‚Çπ<span id="stake">0</span></div>
        <button onclick="location.href='lobby.html'" style="color:white; background:red; border:none; border-radius:4px;">EXIT</button>
    </div>

    <div class="table">
        <div class="player p1 active" id="u1">YOU<br><span id="tm">30</span></div>
        <div class="player p2" id="u2">BOT 1</div>
        <div class="player p3" id="u3">BOT 2</div>
        <div class="player p4" id="u4">BOT 3</div>
        <div class="cards-area">
            <div class="deck" onclick="pick()">üé¥</div>
            <div class="open-card" id="opC">‚ô•Ô∏èA</div>
        </div>
    </div>
    <div class="hand" id="myHand"></div>
    <div class="controls">
        <button class="btn" style="background:red;" onclick="endGame('LOSS')">DROP</button>
        <button class="btn" style="background:blue;" onclick="sortH()">SORT</button>
        <button class="btn" style="background:green;" onclick="checkDeclare()">DECLARE</button>
    </div>

    <script>
        let stake = parseInt(localStorage.getItem('currentEntryFee')) || 500;
        document.getElementById('stake').innerText = stake.toLocaleString();
        document.getElementById('bal').innerText = localStorage.getItem('coins');

        let hand = [];
        const suits = ['‚ô•Ô∏è','‚ô†Ô∏è','‚ô¶Ô∏è','‚ô£Ô∏è'];
        const vals = ['A','2','3','4','5','6','7','8','9','10','J','Q','K'];

        function init() {
            for(let i=0; i<13; i++) hand.push(suits[Math.floor(Math.random()*4)] + vals[Math.floor(Math.random()*13)]);
            render();
        }

        function render() {
            const container = document.getElementById('myHand');
            container.innerHTML = '';
            hand.forEach((c, i) => {
                const div = document.createElement('div');
                div.className = 'card';
                div.style.color = (c.includes('‚ô•Ô∏è') || c.includes('‚ô¶Ô∏è')) ? 'red' : 'black';
                div.innerText = c;
                div.onclick = () => drop(i);
                container.appendChild(div);
            });
        }

        function pick() { if(hand.length < 14) { hand.push(suits[Math.floor(Math.random()*4)] + vals[Math.floor(Math.random()*13)]); render(); } }
        
        function drop(i) {
            if(hand.length < 14) return;
            const discarded = hand.splice(i, 1);
            document.getElementById('opC').innerText = discarded[0];
            render();
            botCycle();
        }

        function botCycle() {
            document.getElementById('u1').classList.remove('active');
            let b = 1;
            let inter = setInterval(() => {
                document.getElementById('u'+(b+1)).classList.add('active');
                setTimeout(() => {
                    document.getElementById('u'+(b+1)).classList.remove('active');
                    b++;
                    if(b > 3) {
                        clearInterval(inter);
                        document.getElementById('u1').classList.add('active');
                        // Random Loss Logic: 70% chance bot wins after few turns
                        if(Math.random() > 0.7) endGame('LOSS');
                    }
                }, 1000);
            }, 1200);
        }

        async function endGame(type) {
            const amount = (type === 'WIN') ? stake * 3 : -stake;
            const response = await fetch('/api/game/update-balance', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name: localStorage.getItem('name'), amount: amount })
            });
            const data = await response.json();
            localStorage.setItem('coins', data.newBalance);
            document.getElementById('bal').innerText = data.newBalance;
            alert(type === 'WIN' ? "You Won ‚Çπ"+amount : "You Lost ‚Çπ"+Math.abs(amount));
            location.href = 'lobby.html';
        }

        function checkDeclare() {
            // High Loss Probability Logic
            if(Math.random() > 0.2) endGame('LOSS');
            else endGame('WIN');
        }

        function sortH() { hand.sort(); render(); }
        init();
    </script>
</body>
</html>
